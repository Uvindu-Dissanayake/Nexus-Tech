import tkinter as tk
from tkinter import ttk, messagebox, simpledialog, filedialog
import sqlite3
from datetime import datetime
import csv
import math

# ------------ Configuration ------------
DB_FILE = "shop.db"
TAX_RATE = 0.15
LOYALTY_PER_DOLLAR = 0.1

# Colors
BG_GRADIENT = "#0e0e10"
CARD_COLOR = "#1a1b26"
TEXT_LIGHT = "#ffffff"
ACCENT = "#7d5fff"
ACCENT_HOVER = "#9b87ff"
GLOW = "#4b39bb"

# Users
USERS = {
    "admin": {"admin": "1234"},
    "staff": {"staff": "5678"}
}

current_user = None
LOGO = None


# ============ Database Initialization ============
def init_db():
    """Initialize all required database tables"""
    conn = sqlite3.connect(DB_FILE)
    conn.execute("PRAGMA foreign_keys = ON;")
    c = conn.cursor()

    # Products table
    c.execute("""
        CREATE TABLE IF NOT EXISTS products (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            category TEXT,
            name TEXT,
            price REAL,
            stock INTEGER
        )
    """)

    # Customers table
    c.execute("""
        CREATE TABLE IF NOT EXISTS customers (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            name TEXT,
            phone TEXT,
            email TEXT,
            loyalty_points INTEGER DEFAULT 0
        )
    """)

    # Sales table
    c.execute("""
        CREATE TABLE IF NOT EXISTS sales (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            invoice_no TEXT UNIQUE,
            customer_id INTEGER,
            total REAL,
            tax REAL,
            discount REAL,
            grand_total REAL,
            payment_method TEXT,
            staff TEXT,
            timestamp TEXT DEFAULT (datetime('now','localtime')),
            FOREIGN KEY(customer_id) REFERENCES customers(id) ON DELETE SET NULL
        )
    """)

    # Sales items table
    c.execute("""
        CREATE TABLE IF NOT EXISTS sales_items (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            sale_id INTEGER,
            product_id INTEGER,
            name TEXT,
            qty INTEGER,
            price REAL,
            subtotal REAL,
            FOREIGN KEY(sale_id) REFERENCES sales(id) ON DELETE CASCADE,
            FOREIGN KEY(product_id) REFERENCES products(id) ON DELETE SET NULL
        )
    """)

    conn.commit()
    conn.close()


def db_query(sql, params=(), fetch=False):
    """Utility function for database queries"""
    conn = sqlite3.connect(DB_FILE)
    conn.row_factory = sqlite3.Row
    cur = conn.cursor()
    cur.execute(sql, params)
    res = cur.fetchall() if fetch else None
    conn.commit()
    conn.close()
    return res


def generate_invoice_no():
    """Generate unique invoice number"""
    t = datetime.now().strftime("%Y%m%d%H%M%S")
    return f"INV{t}"


# ============ Login System ============
class LoginWindow(tk.Tk):
    def __init__(self):
        super().__init__()
        self.title("Nexus Techshop Login")
        self.geometry("430x520")
        self.resizable(False, False)
        self.configure(bg=BG_GRADIENT)
        
        init_db()
        self.show_role_selection()

    def show_role_selection(self):
        """Show role selection screen"""
        for widget in self.winfo_children():
            widget.destroy()

        frame = tk.Frame(self, bg=BG_GRADIENT)
        frame.pack(expand=True, fill="both")

        tk.Label(
            frame,
            text="NEXUS TECHSHOP",
            font=("Arial", 16, "bold"),
            fg=TEXT_LIGHT,
            bg=BG_GRADIENT
        ).pack(pady=(40, 5))

        tk.Label(
            frame,
            text="Powering your tech universe",
            font=("Arial", 10, "italic"),
            fg="#b0b3b8",
            bg=BG_GRADIENT
        ).pack(pady=(0, 25))

        btn_admin = tk.Button(
            frame,
            text="I am Admin",
            font=("Arial", 13, "bold"),
            bg=ACCENT,
            fg="white",
            width=18,
            height=2,
            bd=0,
            command=lambda: self.show_login("admin")
        )
        btn_admin.pack(pady=8)

        btn_staff = tk.Button(
            frame,
            text="I am Staff",
            font=("Arial", 13, "bold"),
            bg=ACCENT,
            fg="white",
            width=18,
            height=2,
            bd=0,
            command=lambda: self.show_login("staff")
        )
        btn_staff.pack(pady=8)

    def show_login(self, role):
        """Show login screen for selected role"""
        for widget in self.winfo_children():
            widget.destroy()

        frame = tk.Frame(self, bg=BG_GRADIENT)
        frame.pack(expand=True, fill="both")

        tk.Label(
            frame,
            text="NEXUS TECHSHOP",
            font=("Arial", 14, "bold"),
            fg=TEXT_LIGHT,
            bg=BG_GRADIENT
        ).pack(pady=(20, 5))

        tk.Label(
            frame,
            text=f"{role.capitalize()} login",
            font=("Arial", 10, "italic"),
            fg="#b0b3b8",
            bg=BG_GRADIENT
        ).pack(pady=(0, 10))

        card = tk.Frame(frame, bg=CARD_COLOR, padx=20, pady=20)
        card.pack(pady=10)

        tk.Label(
            card,
            text=f"{role.upper()} LOGIN",
            font=("Arial", 16, "bold"),
            fg=TEXT_LIGHT,
            bg=CARD_COLOR
        ).pack(pady=(0, 10))

        tk.Label(card, text="Username:", fg=TEXT_LIGHT, bg=CARD_COLOR).pack(anchor="w")
        entry_user = tk.Entry(card, font=("Arial", 11), width=25)
        entry_user.pack(pady=4)

        tk.Label(card, text="Password:", fg=TEXT_LIGHT, bg=CARD_COLOR).pack(anchor="w")
        entry_pass = tk.Entry(card, font=("Arial", 11), width=25, show="*")
        entry_pass.pack(pady=4)

        lbl_error = tk.Label(card, text="", fg="#ff6961", bg=CARD_COLOR)
        lbl_error.pack(pady=4)

        def do_login():
            global current_user
            username = entry_user.get().strip()
            password = entry_pass.get()

            if username in USERS[role] and USERS[role][username] == password:
                current_user = {"role": role, "username": username}
                self.destroy()
                app = MainPOSApp()
                app.mainloop()
            else:
                lbl_error.config(text="Incorrect username or password.")

        tk.Button(
            card,
            text="Login",
            font=("Arial", 12, "bold"),
            bg=ACCENT,
            fg="white",
            width=20,
            bd=0,
            command=do_login
        ).pack(pady=6)

        tk.Button(
            frame,
            text="â† Back",
            font=("Arial", 10),
            bg=ACCENT,
            fg="white",
            width=20,
            bd=0,
            command=self.show_role_selection
        ).pack(pady=10)


# ============ Main POS Application ============
class MainPOSApp(tk.Tk):
    def __init__(self):
        super().__init__()
        self.title("Nexus Techshop - POS System")
        self.geometry("1200x750")
        
        self.cart = []
        self.selected_customer = None

        # Create notebook for tabs
        self.notebook = ttk.Notebook(self)
        self.notebook.pack(fill="both", expand=True, padx=5, pady=5)

        # POS Tab
        self.pos_frame = tk.Frame(self.notebook)
        self.notebook.add(self.pos_frame, text="Point of Sale")
        self.setup_pos_tab()

        # Products Tab
        self.products_frame = tk.Frame(self.notebook)
        self.notebook.add(self.products_frame, text="Products")
        ProductManagementTab(self.products_frame)

        # Reports Tab
        self.reports_frame = tk.Frame(self.notebook)
        self.notebook.add(self.reports_frame, text="Reports")
        ReportsTab(self.reports_frame)

    def setup_pos_tab(self):
        """Setup the main POS interface"""
        main = tk.Frame(self.pos_frame)
        main.pack(fill="both", expand=True, padx=8, pady=8)

        left = tk.Frame(main)
        left.pack(side="left", fill="both", expand=True)

        right = tk.Frame(main, width=380)
        right.pack(side="right", fill="y")

        # Product search
        ProductSearchFrame(left, self).pack(fill="both", expand=True, padx=4, pady=4)

        # Cart and checkout
        CartCheckoutFrame(right, self).pack(fill="both", expand=True, padx=4, pady=4)

    def add_to_cart(self, product_id, name, price, qty):
        """Add item to cart"""
        for item in self.cart:
            if item['product_id'] == product_id:
                item['qty'] += qty
                item['subtotal'] = item['qty'] * item['price']
                return
        
        self.cart.append({
            'product_id': product_id,
            'name': name,
            'price': price,
            'qty': qty,
            'subtotal': price * qty
        })

    def remove_from_cart(self, product_id):
        """Remove item from cart"""
        self.cart = [i for i in self.cart if i['product_id'] != product_id]

    def clear_cart(self):
        """Clear entire cart"""
        self.cart.clear()
        self.selected_customer = None


# ============ Product Search Frame ============
class ProductSearchFrame(tk.Frame):
    def __init__(self, parent, app):
        super().__init__(parent)
        self.app = app

        # Search controls
        top = tk.Frame(self)
        top.pack(fill="x", padx=4, pady=4)
        
        tk.Label(top, text="Search:").pack(side="left", padx=4)
        self.search_var = tk.StringVar()
        tk.Entry(top, textvariable=self.search_var, width=30).pack(side="left", padx=4)
        tk.Button(top, text="Search", command=self.search).pack(side="left", padx=4)
        tk.Button(top, text="Show All", command=self.load_all).pack(side="left", padx=4)

        # Products tree
        self.tree = ttk.Treeview(self, columns=("id", "name", "price", "stock"), show="headings")
        self.tree.heading("id", text="ID")
        self.tree.heading("name", text="Product Name")
        self.tree.heading("price", text="Price")
        self.tree.heading("stock", text="Stock")
        
        self.tree.column("id", width=50)
        self.tree.column("name", width=300)
        self.tree.column("price", width=100)
        self.tree.column("stock", width=80)
        
        self.tree.pack(fill="both", expand=True, padx=4, pady=4)

        # Add controls
        controls = tk.Frame(self)
        controls.pack(fill="x", padx=4, pady=4)
        
        tk.Label(controls, text="Qty:").pack(side="left")
        self.qty_var = tk.IntVar(value=1)
        tk.Spinbox(controls, from_=1, to=999, textvariable=self.qty_var, width=8).pack(side="left", padx=4)
        tk.Button(controls, text="Add to Cart", command=self.add_to_cart).pack(side="left", padx=4)

        self.load_all()

    def load_all(self):
        """Load all products"""
        for i in self.tree.get_children():
            self.tree.delete(i)
        
        rows = db_query("SELECT id, name, price, stock FROM products ORDER BY name", fetch=True) or []
        for r in rows:
            self.tree.insert("", "end", values=(r['id'], r['name'], f"${r['price']:.2f}", r['stock']))

    def search(self):
        """Search products"""
        term = self.search_var.get().strip()
        if not term:
            self.load_all()
            return
        
        for i in self.tree.get_children():
            self.tree.delete(i)
        
        rows = db_query(
            "SELECT id, name, price, stock FROM products WHERE name LIKE ? ORDER BY name",
            (f"%{term}%",), fetch=True
        ) or []
        
        for r in rows:
            self.tree.insert("", "end", values=(r['id'], r['name'], f"${r['price']:.2f}", r['stock']))

    def add_to_cart(self):
        """Add selected product to cart"""
        sel = self.tree.selection()
        if not sel:
            messagebox.showwarning("Select Product", "Please select a product first.")
            return
        
        vals = self.tree.item(sel[0])['values']
        pid = int(vals[0])
        name = vals[1]
        price = float(vals[2].replace('$', ''))
        stock = int(vals[3])
        qty = self.qty_var.get()
        
        if qty > stock:
            messagebox.showwarning("Insufficient Stock", f"Only {stock} available.")
            return
        
        self.app.add_to_cart(pid, name, price, qty)
        messagebox.showinfo("Added", f"Added {qty}x {name} to cart.")


# ============ Cart and Checkout Frame ============
class CartCheckoutFrame(tk.Frame):
    def __init__(self, parent, app):
        super().__init__(parent)
        self.app = app

        tk.Label(self, text="Cart", font=("Arial", 14, "bold")).pack(pady=6)

        # Cart tree
        self.tree = ttk.Treeview(self, columns=("name", "qty", "price", "subtotal"), show="headings", height=10)
        self.tree.heading("name", text="Item")
        self.tree.heading("qty", text="Qty")
        self.tree.heading("price", text="Price")
        self.tree.heading("subtotal", text="Subtotal")
        
        self.tree.column("name", width=180)
        self.tree.column("qty", width=50)
        self.tree.column("price", width=70)
        self.tree.column("subtotal", width=80)
        
        self.tree.pack(padx=6, pady=4)

        # Buttons
        btns = tk.Frame(self)
        btns.pack(fill="x", padx=6)
        tk.Button(btns, text="Remove", command=self.remove_item).pack(side="left", padx=2)
        tk.Button(btns, text="Clear", command=self.clear_cart).pack(side="left", padx=2)
        tk.Button(btns, text="Refresh", command=self.refresh).pack(side="left", padx=2)

        # Totals
        self.total_label = tk.Label(self, text="Total: $0.00", font=("Arial", 12, "bold"))
        self.total_label.pack(pady=10)

        # Payment method
        payment_frame = tk.Frame(self)
        payment_frame.pack(fill="x", padx=6, pady=4)
        tk.Label(payment_frame, text="Payment:").pack(side="left")
        self.payment_var = tk.StringVar(value="Cash")
        ttk.Combobox(payment_frame, textvariable=self.payment_var, values=["Cash", "Card", "Other"], width=12).pack(side="left", padx=4)

        # Checkout button
        tk.Button(self, text="CHECKOUT", font=("Arial", 12, "bold"), bg=ACCENT, fg="white", command=self.checkout).pack(pady=10)

    def refresh(self):
        """Refresh cart display"""
        for i in self.tree.get_children():
            self.tree.delete(i)
        
        total = 0
        for item in self.app.cart:
            self.tree.insert("", "end", values=(
                item['name'],
                item['qty'],
                f"${item['price']:.2f}",
                f"${item['subtotal']:.2f}"
            ))
            total += item['subtotal']
        
        self.total_label.config(text=f"Total: ${total:.2f}")

    def remove_item(self):
        """Remove selected item"""
        sel = self.tree.selection()
        if not sel:
            return
        
        idx = self.tree.index(sel[0])
        if 0 <= idx < len(self.app.cart):
            self.app.cart.pop(idx)
            self.refresh()

    def clear_cart(self):
        """Clear entire cart"""
        if messagebox.askyesno("Confirm", "Clear entire cart?"):
            self.app.clear_cart()
            self.refresh()

    def checkout(self):
        """Process checkout"""
        if not self.app.cart:
            messagebox.showwarning("Empty Cart", "Cart is empty!")
            return
        
        total = sum(item['subtotal'] for item in self.app.cart)
        tax = total * TAX_RATE
        grand_total = total + tax
        
        if messagebox.askyesno("Confirm", f"Total: ${grand_total:.2f}\nProceed with payment?"):
            invoice_no = generate_invoice_no()
            
            # Save to database
            conn = sqlite3.connect(DB_FILE)
            cur = conn.cursor()
            cur.execute("""
                INSERT INTO sales (invoice_no, total, tax, discount, grand_total, payment_method, staff)
                VALUES (?, ?, ?, ?, ?, ?, ?)
            """, (invoice_no, total, tax, 0, grand_total, self.payment_var.get(), current_user['username']))
            
            sale_id = cur.lastrowid
            
            for item in self.app.cart:
                cur.execute("""
                    INSERT INTO sales_items (sale_id, product_id, name, qty, price, subtotal)
                    VALUES (?, ?, ?, ?, ?, ?)
                """, (sale_id, item['product_id'], item['name'], item['qty'], item['price'], item['subtotal']))
                
                cur.execute("UPDATE products SET stock = stock - ? WHERE id = ?", (item['qty'], item['product_id']))
            
            conn.commit()
            conn.close()
            
            messagebox.showinfo("Success", f"Sale completed!\nInvoice: {invoice_no}")
            self.app.clear_cart()
            self.refresh()


# ============ Product Management Tab ============
class ProductManagementTab(tk.Frame):
    def __init__(self, parent):
        super().__init__(parent)
        self.pack(fill="both", expand=True)

        tk.Label(self, text="Product Management", font=("Arial", 16, "bold")).pack(pady=10)

        # Tree
        self.tree = ttk.Treeview(self, columns=("id", "category", "name", "price", "stock"), show="headings")
        for col in ["id", "category", "name", "price", "stock"]:
            self.tree.heading(col, text=col.capitalize())
        self.tree.pack(fill="both", expand=True, padx=10, pady=5)

        # Form
        form = tk.Frame(self)
        form.pack(fill="x", padx=10, pady=5)

        tk.Label(form, text="Category:").grid(row=0, column=0, sticky="e", padx=5)
        self.cat_entry = tk.Entry(form, width=20)
        self.cat_entry.grid(row=0, column=1, padx=5)

        tk.Label(form, text="Name:").grid(row=0, column=2, sticky="e", padx=5)
        self.name_entry = tk.Entry(form, width=30)
        self.name_entry.grid(row=0, column=3, padx=5)

        tk.Label(form, text="Price:").grid(row=1, column=0, sticky="e", padx=5)
        self.price_entry = tk.Entry(form, width=20)
        self.price_entry.grid(row=1, column=1, padx=5)

        tk.Label(form, text="Stock:").grid(row=1, column=2, sticky="e", padx=5)
        self.stock_entry = tk.Entry(form, width=20)
        self.stock_entry.grid(row=1, column=3, padx=5)

        # Buttons
        btn_frame = tk.Frame(self)
        btn_frame.pack(fill="x", padx=10, pady=5)

        tk.Button(btn_frame, text="Add Product", command=self.add_product).pack(side="left", padx=5)
        tk.Button(btn_frame, text="Update", command=self.update_product).pack(side="left", padx=5)
        tk.Button(btn_frame, text="Delete", command=self.delete_product).pack(side="left", padx=5)
        tk.Button(btn_frame, text="Refresh", command=self.load_products).pack(side="left", padx=5)

        self.load_products()

    def load_products(self):
        """Load all products"""
        for i in self.tree.get_children():
            self.tree.delete(i)
        
        rows = db_query("SELECT id, category, name, price, stock FROM products ORDER BY id", fetch=True) or []
        for r in rows:
            self.tree.insert("", "end", values=(r['id'], r['category'], r['name'], f"{r['price']:.2f}", r['stock']))

    def add_product(self):
        """Add new product"""
        try:
            cat = self.cat_entry.get().strip()
            name = self.name_entry.get().strip()
            price = float(self.price_entry.get())
            stock = int(self.stock_entry.get())
            
            db_query("INSERT INTO products (category, name, price, stock) VALUES (?, ?, ?, ?)",
                    (cat, name, price, stock))
            
            messagebox.showinfo("Success", "Product added!")
            self.load_products()
        except ValueError:
            messagebox.showerror("Error", "Invalid price or stock value.")

    def update_product(self):
        """Update selected product"""
        sel = self.tree.selection()
        if not sel:
            messagebox.showwarning("Select", "Select a product to update.")
            return
        
        try:
            pid = int(self.tree.item(sel[0])['values'][0])
            cat = self.cat_entry.get().strip()
            name = self.name_entry.get().strip()
            price = float(self.price_entry.get())
            stock = int(self.stock_entry.get())
            
            db_query("UPDATE products SET category=?, name=?, price=?, stock=? WHERE id=?",
                    (cat, name, price, stock, pid))
            
            messagebox.showinfo("Success", "Product updated!")
            self.load_products()
        except ValueError:
            messagebox.showerror("Error", "Invalid values.")

    def delete_product(self):
        """Delete selected product"""
        sel = self.tree.selection()
        if not sel:
            messagebox.showwarning("Select", "Select a product to delete.")
            return
        
        pid = int(self.tree.item(sel[0])['values'][0])
        if messagebox.askyesno("Confirm", "Delete this product?"):
            db_query("DELETE FROM products WHERE id=?", (pid,))
            messagebox.showinfo("Success", "Product deleted!")
            self.load_products()


# ============ Reports Tab ============
class ReportsTab(tk.Frame):
    def __init__(self, parent):
        super().__init__(parent)
        self.pack(fill="both", expand=True)

        tk.Label(self, text="Sales Reports", font=("Arial", 16, "bold")).pack(pady=10)

        self.tree = ttk.Treeview(self, columns=("invoice", "date", "total", "payment"), show="headings")
        self.tree.heading("invoice", text="Invoice")
        self.tree.heading("date", text="Date")
        self.tree.heading("total", text="Total")
        self.tree.heading("payment", text="Payment")
        self.tree.pack(fill="both", expand=True, padx=10, pady=5)

        tk.Button(self, text="Refresh", command=self.load_sales).pack(pady=5)

        self.load_sales()

    def load_sales(self):
        """Load sales history"""
        for i in self.tree.get_children():
            self.tree.delete(i)
        
        rows = db_query("SELECT invoice_no, timestamp, grand_total, payment_method FROM sales ORDER BY timestamp DESC LIMIT 50", fetch=True) or []
        for r in rows:
            self.tree.insert("", "end", values=(r['invoice_no'], r['timestamp'], f"${r['grand_total']:.2f}", r['payment_method']))


# ============ Main Entry Point ============
if __name__ == "__main__":
    init_db()
    login = LoginWindow()
    login.mainloop()
