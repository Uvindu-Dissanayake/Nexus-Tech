#!/usr/bin/env python3
"""
NEXUS TECHSHOP – Combined System (Single File, MySQL)
Uses MySQL database: nexus
Tables: users, customers, products, orders, order_items
"""

import tkinter as tk
from tkinter import ttk, messagebox, simpledialog, filedialog
import math
from datetime import datetime
import csv

# ---------- Optional external libs ----------
HAS_REPORTLAB = True
try:
    from reportlab.lib.pagesizes import A4
    from reportlab.pdfgen import canvas as pdfcanvas
except Exception:
    HAS_REPORTLAB = False

HAS_MYSQL = True
try:
    import mysql.connector
except Exception:
    HAS_MYSQL = False

# ---------- UI COLORS ----------
BG_GRADIENT = "#0e0e10"
CARD_COLOR = "#1a1b26"
TEXT_LIGHT = "#ffffff"
ACCENT = "#7d5fff"
ACCENT_HOVER = "#9b87ff"
GLOW = "#4b39bb"

LOGO = None
current_user = None  # (username, role)

# ---------- POS CONFIG ----------
TAX_RATE = 0.15          # 15% GST
LOYALTY_PER_DOLLAR = 0.1 # 0.1 point per $1


# =====================================================
# DB CONNECTION (MySQL - nexus)
# =====================================================
def get_db_connection():
    if not HAS_MYSQL:
        raise RuntimeError("mysql-connector-python is not installed.")
    # TODO: adjust for your environment if needed
    conn = mysql.connector.connect(
        host="localhost",
        user="root",
        password="your_password_here",  # <-- CHANGE THIS
        database="nexus"
    )
    return conn


# =====================================================
# HELPERS
# =====================================================
def clear_root():
    """Remove all widgets from the main window."""
    for w in root.winfo_children():
        w.destroy()


def load_logo():
    global LOGO
    try:
        LOGO = tk.PhotoImage(file="nexus_logo.png")
    except Exception:
        LOGO = None


def generate_invoice_no():
    return "ORD" + datetime.now().strftime("%Y%m%d%H%M%S")


# =====================================================
# SALES REPORTS PAGE (uses orders table)
# =====================================================
class ReportPage(ttk.Frame):
    def __init__(self, parent):
        super().__init__(parent)
        self.pack(fill="both", expand=True)

        ttk.Label(self, text="Sales Reports Dashboard",
                  font=("Arial", 20, "bold")).pack(pady=10)

        ttk.Button(self, text="← Back to Main Menu",
                   command=open_main_menu).pack(pady=5)

        btn_frame = ttk.Frame(self)
        btn_frame.pack(pady=10)
        ttk.Button(btn_frame, text="Line Chart", command=self.show_line).grid(row=0, column=0, padx=10)
        ttk.Button(btn_frame, text="Bar Chart", command=self.show_bar).grid(row=0, column=1, padx=10)
        ttk.Button(btn_frame, text="Pie Chart", command=self.show_pie).grid(row=0, column=2, padx=10)

        self.canvas = tk.Canvas(self, width=700, height=420, bg="white",
                                highlightthickness=1, highlightbackground="black")
        self.canvas.pack(pady=20)

        self.months = []
        self.values = []
        self.load_sales_data()
        if not self.months:
            # fallback sample
            self.months = ["Jan", "Feb", "Mar", "Apr", "May"]
            self.values = [10, 25, 18, 30, 22]

        self.show_line()

    def load_sales_data(self):
        """Load monthly sales totals from orders table."""
        try:
            conn = get_db_connection()
            cur = conn.cursor()
            cur.execute("""
                SELECT DATE_FORMAT(created_at, '%b') AS month_name,
                       SUM(total) AS total_sales
                FROM orders
                GROUP BY DATE_FORMAT(created_at, '%Y-%m')
                ORDER BY MIN(created_at)
                LIMIT 6
            """)
            rows = cur.fetchall()
            conn.close()
            self.months = [r[0] for r in rows]
            self.values = [float(r[1]) for r in rows]
        except Exception as e:
            print("Error loading report data:", e)
            self.months = []
            self.values = []

    def show_line(self):
        self.canvas.delete("all")
        if not self.values:
            return
        months = self.months
        values = self.values
        max_val = max(values) or 1

        for y in range(50, 351, 50):
            self.canvas.create_line(50, y, 650, y, fill="#e0e0e0")

        self.canvas.create_line(50, 350, 650, 350, width=2)
        self.canvas.create_line(50, 350, 50, 50, width=2)

        for i in range(len(values) - 1):
            x1 = 100 + i * 100
            y1 = 350 - (values[i] / max_val) * 250
            x2 = 100 + (i + 1) * 100
            y2 = 350 - (values[i + 1] / max_val) * 250
            self.canvas.create_line(x1, y1, x2, y2, fill="blue", width=3)
            self.canvas.create_oval(x1 - 5, y1 - 5, x1 + 5, y1 + 5, fill="blue")

        lx = 100 + (len(values) - 1) * 100
        ly = 350 - (values[-1] / max_val) * 250
        self.canvas.create_oval(lx - 5, ly - 5, lx + 5, ly + 5, fill="blue")

        for i, m in enumerate(months):
            x = 100 + i * 100
            self.canvas.create_text(x, 365, text=m, font=("Arial", 10))

        self.canvas.create_text(350, 20, text="Monthly Sales (Line Chart)",
                                font=("Arial", 14, "bold"))

    def show_bar(self):
        self.canvas.delete("all")
        if not self.values:
            return
        months = self.months
        values = self.values
        max_val = max(values) or 1

        bar_width = 60
        gap = 40
        start_x = 100

        self.canvas.create_line(80, 50, 80, 350, width=2)
        self.canvas.create_line(80, 350, 650, 350, width=2)

        for i, val in enumerate(values):
            x1 = start_x + i * (bar_width + gap)
            y1 = 350 - (val / max_val) * 250
            x2 = x1 + bar_width
            y2 = 350
            self.canvas.create_rectangle(x1, y1, x2, y2, fill="skyblue", outline="black")
            self.canvas.create_text(x1 + bar_width / 2, y1 - 10,
                                    text=f"{val:.0f}", font=("Arial", 10))
            self.canvas.create_text(x1 + bar_width / 2, 365,
                                    text=months[i], font=("Arial", 10))

        self.canvas.create_text(350, 20, text="Monthly Sales (Bar Chart)",
                                font=("Arial", 14, "bold"))

    def show_pie(self):
        self.canvas.delete("all")
        if not self.values:
            return
        months = self.months
        values = self.values
        total = sum(values) or 1
        start_angle = 0
        colors = ["red", "green", "blue", "orange", "purple", "cyan"]

        for i, val in enumerate(values):
            extent = (val / total) * 360
            color = colors[i % len(colors)]
            self.canvas.create_arc(150, 50, 550, 450,
                                   start=start_angle, extent=extent,
                                   fill=color)
            mid = math.radians(start_angle + extent / 2)
            lx = 350 + 150 * math.cos(mid)
            ly = 250 + 150 * math.sin(mid)
            self.canvas.create_text(lx, ly, text=f"{months[i]} ({val:.0f})")
            start_angle += extent

        self.canvas.create_text(350, 20, text="Monthly Sales (Pie Chart)",
                                font=("Arial", 14, "bold"))


# =====================================================
# CUSTOMER MANAGEMENT (uses customers table)
# =====================================================
class CustomerManagementPage(ttk.Frame):
    def __init__(self, parent):
        super().__init__(parent)
        self.pack(fill="both", expand=True)

        header = ttk.Frame(self)
        header.pack(fill="x", pady=5)
        ttk.Button(header, text="← Back to Main Menu",
                   command=open_main_menu).pack(side="left", padx=5)
        ttk.Label(header, text="Customer Management",
                  font=("Arial", 18, "bold")).pack(side="left", padx=10)

        top = ttk.Frame(self)
        top.pack(fill="x", padx=10, pady=5)

        ttk.Label(top, text="Search (name/phone/email):").pack(side="left")
        self.search_var = tk.StringVar()
        ttk.Entry(top, textvariable=self.search_var, width=30).pack(side="left", padx=5)
        ttk.Button(top, text="Search", command=self.search_customers).pack(side="left", padx=3)
        ttk.Button(top, text="Show All", command=self.load_customers).pack(side="left", padx=3)

        # Customer list
        self.tree = ttk.Treeview(self, columns=("id","name","phone","email","type","points"),
                                 show="headings", height=12)
        for col, w in (("id",60),("name",160),("phone",120),
                       ("email",200),("type",80),("points",80)):
            self.tree.heading(col, text=col.title())
            self.tree.column(col, width=w, anchor="center")
        self.tree.pack(fill="both", expand=True, padx=10, pady=5)

        # Form for add/update
        form = ttk.Frame(self)
        form.pack(fill="x", padx=10, pady=5)

        ttk.Label(form, text="Name:").grid(row=0, column=0, sticky="e")
        ttk.Label(form, text="Phone:").grid(row=1, column=0, sticky="e")
        ttk.Label(form, text="Email:").grid(row=2, column=0, sticky="e")
        ttk.Label(form, text="Type:").grid(row=3, column=0, sticky="e")
        ttk.Label(form, text="Points:").grid(row=4, column=0, sticky="e")

        self.name_var = tk.StringVar()
        self.phone_var = tk.StringVar()
        self.email_var = tk.StringVar()
        self.type_var = tk.StringVar(value="Standard")
        self.points_var = tk.StringVar(value="0")

        ttk.Entry(form, textvariable=self.name_var, width=30).grid(row=0, column=1, padx=5, pady=2)
        ttk.Entry(form, textvariable=self.phone_var, width=30).grid(row=1, column=1, padx=5, pady=2)
        ttk.Entry(form, textvariable=self.email_var, width=30).grid(row=2, column=1, padx=5, pady=2)
        ttk.Combobox(form, textvariable=self.type_var,
                     values=["Standard","VIP"], width=27,
                     state="readonly").grid(row=3, column=1, padx=5, pady=2)
        ttk.Entry(form, textvariable=self.points_var, width=30).grid(row=4, column=1, padx=5, pady=2)

        btns = ttk.Frame(self)
        btns.pack(fill="x", padx=10, pady=5)
        ttk.Button(btns, text="Add New", command=self.add_customer).pack(side="left", padx=3)
        ttk.Button(btns, text="Update Selected", command=self.update_customer).pack(side="left", padx=3)
        ttk.Button(btns, text="Clear Fields", command=self.clear_form).pack(side="left", padx=3)

        self.status_label = ttk.Label(self, text="", foreground="green")
        self.status_label.pack(pady=5)

        self.load_customers()

    def load_customers(self):
        for i in self.tree.get_children():
            self.tree.delete(i)
        try:
            conn = get_db_connection()
            cur = conn.cursor()
            cur.execute("SELECT id, name, phone, email, type, points FROM customers ORDER BY id DESC")
            rows = cur.fetchall()
            conn.close()
            for r in rows:
                self.tree.insert("", "end", values=r)
        except Exception as e:
            self.status_label.config(text=f"Error loading customers: {e}",
                                     foreground="red")

    def search_customers(self):
        term = self.search_var.get().strip()
        if not term:
            self.load_customers()
            return
        for i in self.tree.get_children():
            self.tree.delete(i)
        try:
            conn = get_db_connection()
            cur = conn.cursor()
            like = f"%{term}%"
            cur.execute("""
                SELECT id, name, phone, email, type, points
                FROM customers
                WHERE name LIKE %s OR phone LIKE %s OR email LIKE %s
                ORDER BY id DESC
            """, (like, like, like))
            rows = cur.fetchall()
            conn.close()
            for r in rows:
                self.tree.insert("", "end", values=r)
        except Exception as e:
            self.status_label.config(text=f"Search error: {e}", foreground="red")

    def add_customer(self):
        name = self.name_var.get().strip()
        if not name:
            self.status_label.config(text="Name is required.", foreground="red")
            return
        phone = self.phone_var.get().strip()
        email = self.email_var.get().strip()
        ctype = self.type_var.get()
        try:
            points = int(self.points_var.get() or "0")
        except:
            points = 0
        try:
            conn = get_db_connection()
            cur = conn.cursor()
            cur.execute("""
                INSERT INTO customers (name, phone, email, type, points)
                VALUES (%s, %s, %s, %s, %s)
            """, (name, phone, email, ctype, points))
            conn.commit()
            conn.close()
            self.status_label.config(text="Customer added successfully.",
                                     foreground="green")
            self.load_customers()
            self.clear_form()
        except Exception as e:
            self.status_label.config(text=f"Add error: {e}", foreground="red")

    def update_customer(self):
        sel = self.tree.selection()
        if not sel:
            self.status_label.config(text="Select a customer to update.",
                                     foreground="red")
            return
        vals = self.tree.item(sel[0])["values"]
        cust_id = vals[0]
        name = self.name_var.get().strip()
        if not name:
            self.status_label.config(text="Name is required.", foreground="red")
            return
        phone = self.phone_var.get().strip()
        email = self.email_var.get().strip()
        ctype = self.type_var.get()
        try:
            points = int(self.points_var.get() or "0")
        except:
            points = 0
        try:
            conn = get_db_connection()
            cur = conn.cursor()
            cur.execute("""
                UPDATE customers
                SET name=%s, phone=%s, email=%s, type=%s, points=%s
                WHERE id=%s
            """, (name, phone, email, ctype, points, cust_id))
            conn.commit()
            conn.close()
            self.status_label.config(text="Customer updated successfully.",
                                     foreground="green")
            self.load_customers()
        except Exception as e:
            self.status_label.config(text=f"Update error: {e}", foreground="red")

    def clear_form(self):
        self.name_var.set("")
        self.phone_var.set("")
        self.email_var.set("")
        self.type_var.set("Standard")
        self.points_var.set("0")
        self.status_label.config(text="")


# =====================================================
# POS SYSTEM (uses products, customers, orders, order_items)
# =====================================================
class POSApp(ttk.Frame):
    def __init__(self, master):
        super().__init__(master)
        self.pack(fill="both", expand=True)
        master.title("Nexus POS - Billing System")
        master.geometry("1150x720")

        self.cart = []  # list of dicts: product_id, name, price, qty, subtotal
        self.selected_customer = None  # (id, name)
        self.staff_username = current_user[0] if current_user else "staff"

        topbar = ttk.Frame(self)
        topbar.pack(fill="x")
        ttk.Button(topbar, text="← Back to Main Menu",
                   command=open_main_menu).pack(side="left", padx=4, pady=4)
        ttk.Label(topbar, text="POS - Billing System",
                  font=("Helvetica", 14, "bold")).pack(side="left", padx=10)

        main = ttk.Frame(self)
        main.pack(fill="both", expand=True, padx=8, pady=8)

        left = ttk.Frame(main)
        left.pack(side="left", fill="both", expand=True)
        right = ttk.Frame(main, width=420)
        right.pack(side="right", fill="y")

        self.product_search_frame = ProductSearchFrame(left, self)
        self.product_search_frame.pack(fill="both", expand=True, padx=4, pady=4)

        self.cart_frame = CartCheckoutFrame(right, self)
        self.cart_frame.pack(fill="y", expand=False, padx=4, pady=4)

        bottom = ttk.Frame(self)
        bottom.pack(fill="x", padx=8, pady=4)
        ttk.Button(bottom, text="Export Orders CSV",
                   command=self.export_orders_csv).pack(side="left", padx=4)
        ttk.Button(bottom, text="Open Product Manager",
                   command=self.open_product_manager).pack(side="left", padx=4)

        self.after(200, self.product_search_frame.focus_scanner_entry)

    # ----- Cart ops -----
    def add_to_cart(self, product_id, name, price, qty):
        for item in self.cart:
            if item["product_id"] == product_id:
                item["qty"] += qty
                item["subtotal"] = item["qty"] * item["price"]
                self.cart_frame.refresh_cart()
                return
        self.cart.append({
            "product_id": product_id,
            "name": name,
            "price": price,
            "qty": qty,
            "subtotal": price * qty
        })
        self.cart_frame.refresh_cart()

    def remove_from_cart(self, product_id):
        self.cart = [i for i in self.cart if i["product_id"] != product_id]
        self.cart_frame.refresh_cart()

    def clear_cart(self):
        self.cart.clear()
        self.selected_customer = None
        self.cart_frame.refresh_cart()

    def compute_totals(self, discount_percent=0.0, discount_amount=0.0):
        subtotal = sum(i["subtotal"] for i in self.cart)
        tax = subtotal * TAX_RATE
        disc_percent_value = subtotal * (discount_percent / 100.0)
        discount = disc_percent_value + discount_amount
        grand_total = max(0.0, subtotal + tax - discount)
        return {
            "subtotal": subtotal,
            "tax": tax,
            "discount": discount,
            "grand_total": grand_total
        }

    def checkout(self, payment_method, discount_percent=0.0,
                 discount_amount=0.0, payment_details=None):
        if not self.cart:
            messagebox.showwarning("Empty Cart", "Cart is empty.")
            return False

        totals = self.compute_totals(discount_percent, discount_amount)
        invoice_no = generate_invoice_no()
        cust_id = self.selected_customer[0] if self.selected_customer else None

        try:
            conn = get_db_connection()
            cur = conn.cursor()

            # Insert into orders
            cur.execute("""
                INSERT INTO orders (customer_id, staff_username, total, created_at)
                VALUES (%s, %s, %s, %s)
            """, (cust_id, self.staff_username, totals["grand_total"],
                  datetime.now()))
            order_id = cur.lastrowid

            # Insert into order_items and update stock
            for item in self.cart:
                cur.execute("""
                    INSERT INTO order_items (order_id, product_id, quantity, price_at_sale)
                    VALUES (%s, %s, %s, %s)
                """, (order_id, item["product_id"], item["qty"], item["price"]))
                cur.execute("""
                    UPDATE products SET stock = stock - %s WHERE id = %s
                """, (item["qty"], item["product_id"]))

            # Loyalty points
            if cust_id:
                points_earned = int(totals["grand_total"] * LOYALTY_PER_DOLLAR)
                cur.execute("""
                    UPDATE customers
                    SET points = points + %s
                    WHERE id = %s
                """, (points_earned, cust_id))
            else:
                points_earned = 0

            conn.commit()
            conn.close()
        except Exception as e:
            messagebox.showerror("Checkout Error", f"Failed to complete sale: {e}")
            return False

        self.show_receipt(invoice_no, order_id, totals, payment_method,
                          points_earned, payment_details)
        self.clear_cart()
        return True

    def show_receipt(self, invoice_no, order_id, totals, payment_method,
                     loyalty_earned, payment_details=None):
        # Get order_items with product names
        lines = []
        try:
            conn = get_db_connection()
            cur = conn.cursor()
            cur.execute("""
                SELECT p.name, oi.quantity, oi.price_at_sale,
                       (oi.quantity * oi.price_at_sale) AS subtotal
                FROM order_items oi
                JOIN products p ON p.id = oi.product_id
                WHERE oi.order_id = %s
            """, (order_id,))
            rows = cur.fetchall()
            conn.close()
        except Exception as e:
            rows = []
            print("Error loading items for receipt:", e)

        receipt_win = tk.Toplevel(self)
        receipt_win.title(f"Receipt - {invoice_no}")
        receipt_win.geometry("600x600")

        txt = tk.Text(receipt_win, width=80, height=30, wrap="none")
        txt.pack(side="left", fill="both", expand=True, padx=6, pady=6)
        scroll = ttk.Scrollbar(receipt_win, orient="vertical", command=txt.yview)
        scroll.pack(side="right", fill="y")
        txt.config(yscrollcommand=scroll.set)

        now = datetime.now().strftime("%Y-%m-%d %H:%M:%S")
        lines.append("=== NEXUS TECH SHOP ===")
        lines.append(f"Invoice: {invoice_no}")
        lines.append(f"Date: {now}")
        if self.selected_customer:
            lines.append(f"Customer: {self.selected_customer[1]} (ID:{self.selected_customer[0]})")
        if current_user:
            lines.append(f"Staff: {current_user[0]}")
        lines.append("-" * 48)
        lines.append(f"{'Item':30} {'Qty':>3} {'Price':>8} {'Sub':>9}")
        lines.append("-" * 48)
        for r in rows:
            name, qty, price, sub = r
            lines.append(f"{name[:30]:30} {qty:>3} {float(price):>8.2f} {float(sub):>9.2f}")
        lines.append("-" * 48)
        lines.append(f"Subtotal: ${totals['subtotal']:.2f}")
        lines.append(f"Tax ({TAX_RATE*100:.0f}%): ${totals['tax']:.2f}")
        lines.append(f"Discount: -${totals['discount']:.2f}")
        lines.append(f"Grand Total: ${totals['grand_total']:.2f}")
        lines.append(f"Payment: {payment_method} {('('+str(payment_details)+')') if payment_details else ''}")
        if loyalty_earned:
            lines.append(f"Loyalty points earned: {loyalty_earned}")
        lines.append("Thank you for shopping with us!")
        lines.append("=== Powered by Nexus POS ===")

        content = "\n".join(lines)
        txt.insert("1.0", content)
        txt.config(state="disabled")

        btn_frame = ttk.Frame(receipt_win)
        btn_frame.pack(fill="x", padx=6, pady=6)
        ttk.Button(btn_frame, text="Save Receipt (.txt)",
                   command=lambda: self.save_receipt_text(invoice_no, content)).pack(side="left", padx=4)
        ttk.Button(btn_frame, text="Save Receipt (.pdf)",
                   command=lambda: self.save_receipt_pdf(invoice_no, lines)).pack(side="left", padx=4)
        ttk.Button(btn_frame, text="Close", command=receipt_win.destroy).pack(side="right", padx=4)

    def save_receipt_text(self, invoice_no, content):
        fn = filedialog.asksaveasfilename(defaultextension=".txt",
                                          initialfile=f"{invoice_no}.txt")
        if not fn:
            return
        with open(fn, "w", encoding="utf-8") as f:
            f.write(content)
        messagebox.showinfo("Saved", f"Receipt saved to {fn}")

    def save_receipt_pdf(self, invoice_no, lines):
        if not HAS_REPORTLAB:
            messagebox.showerror("PDF Not Available",
                                 "Install reportlab: pip install reportlab")
            return
        fn = filedialog.asksaveasfilename(defaultextension=".pdf",
                                          initialfile=f"{invoice_no}.pdf")
        if not fn:
            return
        try:
            c = pdfcanvas.Canvas(fn, pagesize=A4)
            width, height = A4
            x = 40
            y = height - 40
            line_height = 14
            c.setFont("Courier", 10)
            for line in lines:
                if y < 40:
                    c.showPage()
                    y = height - 40
                    c.setFont("Courier", 10)
                c.drawString(x, y, line)
                y -= line_height
            c.save()
            messagebox.showinfo("Saved", f"PDF receipt saved to {fn}")
        except Exception as e:
            messagebox.showerror("PDF Error", f"Failed to save PDF: {e}")

    def export_orders_csv(self):
        try:
            conn = get_db_connection()
            cur = conn.cursor()
            cur.execute("""
                SELECT o.id, o.created_at, o.total, c.name AS customer
                FROM orders o
                LEFT JOIN customers c ON c.id = o.customer_id
                ORDER BY o.created_at DESC
            """)
            rows = cur.fetchall()
            conn.close()
            if not rows:
                messagebox.showinfo("No Data", "No orders to export.")
                return
        except Exception as e:
            messagebox.showerror("Error", f"Unable to load orders: {e}")
            return

        fn = filedialog.asksaveasfilename(defaultextension=".csv",
                                          initialfile="orders_export.csv")
        if not fn:
            return
        with open(fn, "w", newline="", encoding="utf-8") as f:
            w = csv.writer(f)
            w.writerow(["Order ID","Date","Total","Customer"])
            for r in rows:
                w.writerow([r[0], r[1], float(r[2]), r[3] or ""])
        messagebox.showinfo("Exported", f"Orders exported to {fn}")

    def open_product_manager(self):
        pm = ProductQuickManager(self)
        pm.grab_set()


class ProductSearchFrame(ttk.Frame):
    def __init__(self, parent, app: POSApp):
        super().__init__(parent)
        self.app = app

        top = ttk.Frame(self)
        top.pack(fill="x", padx=4, pady=4)

        ttk.Label(top, text="Scan Barcode / ID:").pack(side="left", padx=4)
        self.scan_var = tk.StringVar()
        self.scan_entry = ttk.Entry(top, textvariable=self.scan_var, width=25)
        self.scan_entry.pack(side="left", padx=4)
        self.scan_entry.bind("<Return>", self.on_scan_enter)

        ttk.Label(top, text="Search Product:").pack(side="left", padx=8)
        self.search_var = tk.StringVar()
        ttk.Entry(top, textvariable=self.search_var, width=40).pack(side="left", padx=4)
        ttk.Button(top, text="Search", command=self.search).pack(side="left", padx=4)
        ttk.Button(top, text="Show All", command=self.load_all).pack(side="left", padx=4)

        middle = ttk.Frame(self)
        middle.pack(fill="both", expand=True, padx=4, pady=4)

        left_list = ttk.Frame(middle)
        left_list.pack(side="left", fill="y")
        ttk.Label(left_list, text="Categories").pack(anchor="w")
        self.cat_listbox = tk.Listbox(left_list, height=15)
        self.cat_listbox.pack(fill="y", expand=False)
        self.cat_listbox.bind("<<ListboxSelect>>", self.on_cat_select)

        self.tree = ttk.Treeview(middle,
                                 columns=("id","name","price","stock","category"),
                                 show="headings")
        for col, w in (("id",60),("name",260),("price",80),("stock",80),("category",120)):
            self.tree.heading(col, text=col.title())
            self.tree.column(col, width=w, anchor="center")
        self.tree.pack(side="left", fill="both", expand=True, padx=6)

        right_controls = ttk.Frame(middle)
        right_controls.pack(side="right", fill="y", padx=6)
        ttk.Label(right_controls, text="Quantity").pack(pady=(4,0))
        self.qty_var = tk.IntVar(value=1)
        ttk.Spinbox(right_controls, from_=1, to=999,
                    textvariable=self.qty_var, width=8).pack(pady=4)
        ttk.Button(right_controls, text="Add to Cart",
                   command=self.add_selected_to_cart).pack(pady=6)

        self.load_categories()
        self.load_all()

    def focus_scanner_entry(self):
        try:
            self.scan_entry.focus_set()
        except Exception:
            pass

    def load_categories(self):
        self.cat_listbox.delete(0, "end")
        cats = []
        try:
            conn = get_db_connection()
            cur = conn.cursor()
            cur.execute("SELECT DISTINCT category FROM products ORDER BY category")
            rows = cur.fetchall()
            conn.close()
            cats = [r[0] for r in rows if r[0]]
        except Exception as e:
            print("Error loading categories:", e)
        cats.insert(0, "All")
        for c in cats:
            self.cat_listbox.insert("end", c)
        self.cat_listbox.selection_set(0)

    def load_all(self):
        for i in self.tree.get_children():
            self.tree.delete(i)
        try:
            conn = get_db_connection()
            cur = conn.cursor()
            cur.execute("SELECT id, name, price, stock, category FROM products ORDER BY id")
            rows = cur.fetchall()
            conn.close()
            for r in rows:
                self.tree.insert("", "end",
                                 values=(r[0], r[1], float(r[2]), r[3], r[4]))
        except Exception as e:
            print("Error loading products:", e)

    def search(self):
        term = self.search_var.get().strip()
        if not term:
            self.load_all()
            return
        for i in self.tree.get_children():
            self.tree.delete(i)
        like = f"%{term}%"
        try:
            conn = get_db_connection()
            cur = conn.cursor()
            cur.execute("""
                SELECT id, name, price, stock, category
                FROM products
                WHERE name LIKE %s OR category LIKE %s
                ORDER BY id
            """, (like, like))
            rows = cur.fetchall()
            conn.close()
            for r in rows:
                self.tree.insert("", "end",
                                 values=(r[0], r[1], float(r[2]), r[3], r[4]))
        except Exception as e:
            print("Search error:", e)

    def on_cat_select(self, event=None):
        sel = self.cat_listbox.curselection()
        if not sel:
            return
        cat = self.cat_listbox.get(sel[0])
        if cat == "All":
            self.load_all()
            return
        for i in self.tree.get_children():
            self.tree.delete(i)
        try:
            conn = get_db_connection()
            cur = conn.cursor()
            cur.execute("""
                SELECT id, name, price, stock, category
                FROM products
                WHERE category=%s
                ORDER BY id
            """, (cat,))
            rows = cur.fetchall()
            conn.close()
            for r in rows:
                self.tree.insert("", "end",
                                 values=(r[0], r[1], float(r[2]), r[3], r[4]))
        except Exception as e:
            print("Category filter error:", e)

    def on_scan_enter(self, event=None):
        code = self.scan_var.get().strip()
        self.scan_var.set("")
        if not code:
            return
        # Here we treat "code" as product ID for simplicity
        try:
            pid = int(code)
        except:
            messagebox.showerror("Error", "Barcode/ID must be numeric in this simple version.")
            return
        try:
            conn = get_db_connection()
            cur = conn.cursor()
            cur.execute("SELECT id, name, price, stock FROM products WHERE id=%s", (pid,))
            row = cur.fetchone()
            conn.close()
            if not row:
                messagebox.showerror("Not found", f"No product with ID {pid}.")
                return
            name, price, stock = row[1], float(row[2]), row[3]
        except Exception as e:
            messagebox.showerror("Error", f"Scan lookup failed: {e}")
            return

        qty = 1
        if stock is not None and qty > stock:
            messagebox.showwarning("Stock", f"Only {stock} available.")
            return
        self.app.add_to_cart(row[0], name, price, qty)
        self.scan_entry.focus_set()

    def add_selected_to_cart(self):
        sel = self.tree.selection()
        if not sel:
            messagebox.showwarning("Select", "Select a product to add.")
            return
        vals = self.tree.item(sel[0])["values"]
        pid = vals[0]
        name = vals[1]
        price = float(vals[2])
        stock = vals[3]
        qty = int(self.qty_var.get() or 1)
        if stock is not None and qty > stock:
            messagebox.showwarning("Stock", f"Only {stock} available.")
            return
        self.app.add_to_cart(pid, name, price, qty)


class CartCheckoutFrame(ttk.Frame):
    def __init__(self, parent, app: POSApp):
        super().__init__(parent)
        self.app = app

        ttk.Label(self, text="Cart & Checkout",
                  font=("Helvetica", 14, "bold")).pack(pady=6)

        self.tree = ttk.Treeview(self,
                                 columns=("product_id","name","qty","price","subtotal"),
                                 show="headings", height=12)
        for col, w in (("product_id",60),("name",200),("qty",60),
                       ("price",80),("subtotal",100)):
            self.tree.heading(col, text=col.title())
            self.tree.column(col, width=w, anchor="center")
        self.tree.pack(padx=6, pady=4)

        btns = ttk.Frame(self)
        btns.pack(fill="x", padx=6)
        ttk.Button(btns, text="Remove Selected",
                   command=self.remove_selected).pack(side="left", padx=3)
        ttk.Button(btns, text="Clear Cart",
                   command=self.clear_cart).pack(side="left", padx=3)
        ttk.Button(btns, text="Edit Qty",
                   command=self.edit_qty).pack(side="left", padx=3)

        frame2 = ttk.Frame(self)
        frame2.pack(fill="x", padx=6, pady=6)

        cust_frame = ttk.Frame(frame2)
        cust_frame.pack(fill="x", pady=3)
        ttk.Label(cust_frame, text="Customer:").pack(side="left")
        self.cust_var = tk.StringVar(value="Guest")
        ttk.Label(cust_frame, textvariable=self.cust_var, width=38).pack(side="left", padx=4)
        ttk.Button(cust_frame, text="Select/Add", command=self.select_customer).pack(side="left", padx=4)

        tot_frame = ttk.Frame(frame2)
        tot_frame.pack(fill="x", pady=3)

        ttk.Label(tot_frame, text="Discount (%)").grid(row=0, column=0, sticky="e")
        self.disc_percent_var = tk.DoubleVar(value=0.0)
        ttk.Entry(tot_frame, textvariable=self.disc_percent_var, width=8).grid(row=0, column=1, padx=4)

        ttk.Label(tot_frame, text="Discount (Amt)").grid(row=0, column=2, sticky="e")
        self.disc_amt_var = tk.DoubleVar(value=0.0)
        ttk.Entry(tot_frame, textvariable=self.disc_amt_var, width=10).grid(row=0, column=3, padx=4)

        ttk.Label(tot_frame, text="Payment Method").grid(row=1, column=0, sticky="e", pady=6)
        self.pay_method_var = tk.StringVar(value="Cash")
        self.pay_method_cb = ttk.Combobox(tot_frame, textvariable=self.pay_method_var,
                                           values=["Cash","Card","PayWave","Online","Bank Transfer"],
                                           width=12, state="readonly")
        self.pay_method_cb.grid(row=1, column=1, padx=4)
        self.pay_method_cb.bind("<<ComboboxSelected>>", self.on_pay_method_change)

        ttk.Label(tot_frame, text="Card Type").grid(row=1, column=2, sticky="e")
        self.card_type_var = tk.StringVar(value="")
        self.card_type_cb = ttk.Combobox(tot_frame, textvariable=self.card_type_var,
                                         values=["Visa","MasterCard","Debit Card","Credit Card"],
                                         width=15, state="readonly")
        self.card_type_cb.grid(row=1, column=3, padx=4)
        if self.pay_method_var.get() != "Card":
            self.card_type_cb.grid_remove()
            for w in tot_frame.grid_slaves(row=1, column=2):
                w.grid_remove()

        display = ttk.Frame(self)
        display.pack(fill="x", padx=6, pady=6)
        self.sub_label = ttk.Label(display, text="Subtotal: $0.00")
        self.sub_label.pack(anchor="w")
        self.tax_label = ttk.Label(display, text=f"Tax ({TAX_RATE*100:.0f}%): $0.00")
        self.tax_label.pack(anchor="w")
        self.disc_label = ttk.Label(display, text="Discount: $0.00")
        self.disc_label.pack(anchor="w")
        self.total_label = ttk.Label(display, text="Grand Total: $0.00",
                                     font=("Helvetica", 12, "bold"))
        self.total_label.pack(anchor="w", pady=4)

        chk_frame = ttk.Frame(self)
        chk_frame.pack(fill="x", padx=6, pady=6)
        ttk.Button(chk_frame, text="Recalculate",
                   command=self.refresh_cart).pack(side="left")
        ttk.Button(chk_frame, text="Checkout",
                   command=self.on_checkout).pack(side="right")

        self.refresh_cart()

    def on_pay_method_change(self, event=None):
        m = self.pay_method_var.get()
        parent = self.card_type_cb.master
        if m == "Card":
            for w in parent.grid_slaves(row=1, column=2):
                w.grid()
            self.card_type_cb.grid()
        else:
            self.card_type_cb.grid_remove()
            for w in parent.grid_slaves(row=1, column=2):
                w.grid_remove()
            self.card_type_var.set("")

    def refresh_cart(self):
        for i in self.tree.get_children():
            self.tree.delete(i)
        for item in self.app.cart:
            self.tree.insert("", "end",
                             values=(item["product_id"], item["name"], item["qty"],
                                     f"{item['price']:.2f}", f"{item['subtotal']:.2f}"))
        if self.app.selected_customer:
            self.cust_var.set(f"{self.app.selected_customer[1]} (ID:{self.app.selected_customer[0]})")
        else:
            self.cust_var.set("Guest")

        totals = self.app.compute_totals(self.disc_percent_var.get() or 0.0,
                                         self.disc_amt_var.get() or 0.0)
        self.sub_label.config(text=f"Subtotal: ${totals['subtotal']:.2f}")
        self.tax_label.config(text=f"Tax ({TAX_RATE*100:.0f}%): ${totals['tax']:.2f}")
        self.disc_label.config(text=f"Discount: ${totals['discount']:.2f}")
        self.total_label.config(text=f"Grand Total: ${totals['grand_total']:.2f}")

    def remove_selected(self):
        sel = self.tree.selection()
        if not sel:
            messagebox.showwarning("Select", "Select an item to remove.")
            return
        pid = int(self.tree.item(sel[0])["values"][0])
        self.app.remove_from_cart(pid)
        self.refresh_cart()

    def clear_cart(self):
        if not messagebox.askyesno("Confirm", "Clear cart?"):
            return
        self.app.clear_cart()
        self.refresh_cart()

    def edit_qty(self):
        sel = self.tree.selection()
        if not sel:
            messagebox.showwarning("Select", "Select an item to edit.")
            return
        pid = int(self.tree.item(sel[0])["values"][0])
        current = next((i for i in self.app.cart if i["product_id"] == pid), None)
        if not current:
            return
        new_qty = simpledialog.askinteger("Quantity", "Enter new quantity",
                                          initialvalue=current["qty"], minvalue=1)
        if new_qty is None:
            return
        # check stock
        try:
            conn = get_db_connection()
            cur = conn.cursor()
            cur.execute("SELECT stock FROM products WHERE id=%s", (pid,))
            row = cur.fetchone()
            conn.close()
            stock = row[0] if row else None
        except Exception:
            stock = None
        if stock is not None and new_qty > stock:
            messagebox.showwarning("Stock", f"Only {stock} available.")
            return
        current["qty"] = new_qty
        current["subtotal"] = current["price"] * new_qty
        self.refresh_cart()

    def select_customer(self):
        dialog = CustomerSelector(self)
        self.wait_window(dialog)
        if dialog.selected_customer:
            self.app.selected_customer = dialog.selected_customer
        self.refresh_cart()

    def on_checkout(self):
        discount_percent = float(self.disc_percent_var.get() or 0.0)
        discount_amount = float(self.disc_amt_var.get() or 0.0)
        payment_method = self.pay_method_var.get() or "Cash"
        payment_details = None
        if payment_method == "Card":
            payment_details = self.card_type_var.get() or "Card"

        totals = self.app.compute_totals(discount_percent, discount_amount)
        pm_text = payment_method + (f" ({payment_details})" if payment_details else "")
        confirm = messagebox.askyesno("Confirm Payment",
                                      f"Charge ${totals['grand_total']:.2f} via {pm_text}?")
        if not confirm:
            return
        ok = self.app.checkout(payment_method, discount_percent, discount_amount, payment_details)
        if ok:
            messagebox.showinfo("Done", "Sale completed.")
            self.refresh_cart()


class CustomerSelector(tk.Toplevel):
    def __init__(self, parent: CartCheckoutFrame):
        super().__init__(parent)
        self.title("Select / Add Customer")
        self.geometry("560x420")
        self.selected_customer = None

        top = ttk.Frame(self)
        top.pack(fill="x", padx=8, pady=6)
        ttk.Label(top, text="Search by name or phone:").pack(side="left")
        self.svar = tk.StringVar()
        ttk.Entry(top, textvariable=self.svar, width=30).pack(side="left", padx=6)
        ttk.Button(top, text="Search", command=self.search).pack(side="left", padx=4)
        ttk.Button(top, text="Show All", command=self.load_all).pack(side="left", padx=4)

        self.tree = ttk.Treeview(self,
                                 columns=("id","name","phone","email","points","type"),
                                 show="headings", height=14)
        for col, w in (("id",60),("name",150),("phone",120),
                       ("email",180),("points",60),("type",80)):
            self.tree.heading(col, text=col.title())
            self.tree.column(col, width=w, anchor="center")
        self.tree.pack(fill="both", expand=True, padx=8, pady=8)

        btns = ttk.Frame(self)
        btns.pack(fill="x", padx=8, pady=6)
        ttk.Button(btns, text="Select", command=self.select).pack(side="left", padx=4)
        ttk.Button(btns, text="Add New", command=self.add_new).pack(side="left", padx=4)
        ttk.Button(btns, text="Close", command=self.destroy).pack(side="right", padx=4)

        self.load_all()

    def load_all(self):
        for i in self.tree.get_children():
            self.tree.delete(i)
        try:
            conn = get_db_connection()
            cur = conn.cursor()
            cur.execute("SELECT id,name,phone,email,points,type FROM customers ORDER BY id DESC")
            rows = cur.fetchall()
            conn.close()
            for r in rows:
                self.tree.insert("", "end", values=r)
        except Exception as e:
            print("Error loading customers:", e)

    def search(self):
        t = self.svar.get().strip()
        if not t:
            self.load_all()
            return
        for i in self.tree.get_children():
            self.tree.delete(i)
        like = f"%{t}%"
        try:
            conn = get_db_connection()
            cur = conn.cursor()
            cur.execute("""
                SELECT id,name,phone,email,points,type
                FROM customers
                WHERE name LIKE %s OR phone LIKE %s
                ORDER BY id DESC
            """, (like, like))
            rows = cur.fetchall()
            conn.close()
            for r in rows:
                self.tree.insert("", "end", values=r)
        except Exception as e:
            print("Search customers error:", e)

    def select(self):
        sel = self.tree.selection()
        if not sel:
            messagebox.showwarning("Select", "Select a customer.")
            return
        vals = self.tree.item(sel[0])["values"]
        self.selected_customer = (vals[0], vals[1])
        self.destroy()

    def add_new(self):
        name = simpledialog.askstring("Name", "Customer name:")
        if not name:
            return
        phone = simpledialog.askstring("Phone", "Phone (optional):")
        email = simpledialog.askstring("Email", "Email (optional):")
        try:
            conn = get_db_connection()
            cur = conn.cursor()
            cur.execute("""
                INSERT INTO customers (name, phone, email, type, points)
                VALUES (%s, %s, %s, %s, %s)
            """, (name, phone, email, "Standard", 0))
            conn.commit()
            conn.close()
            messagebox.showinfo("Added", "Customer added.")
            self.load_all()
        except Exception as e:
            messagebox.showerror("Error", f"Add customer error: {e}")


class ProductQuickManager(tk.Toplevel):
    def __init__(self, app: POSApp):
        super().__init__(app)
        self.title("Quick Product Manager")
        self.geometry("500x300")
        self.app = app

        form = ttk.Frame(self)
        form.pack(fill="x", padx=6, pady=6)
        ttk.Label(form, text="Name").grid(row=0, column=0, sticky="e")
        ttk.Label(form, text="Price").grid(row=1, column=0, sticky="e")
        ttk.Label(form, text="Stock").grid(row=2, column=0, sticky="e")
        ttk.Label(form, text="Category").grid(row=3, column=0, sticky="e")

        self.name_e = ttk.Entry(form, width=30); self.name_e.grid(row=0, column=1, padx=4, pady=3)
        self.price_e = ttk.Entry(form, width=20); self.price_e.grid(row=1, column=1, padx=4, pady=3)
        self.stock_e = ttk.Entry(form, width=20); self.stock_e.grid(row=2, column=1, padx=4, pady=3)
        self.cat_e = ttk.Entry(form, width=20); self.cat_e.grid(row=3, column=1, padx=4, pady=3)

        ttk.Button(self, text="Add Product", command=self.add_product).pack(pady=6)
        ttk.Button(self, text="Close", command=self.destroy).pack(pady=6)

    def add_product(self):
        name = self.name_e.get().strip()
        if not name:
            messagebox.showerror("Error", "Product name required.")
            return
        try:
            price = float(self.price_e.get().strip())
        except:
            messagebox.showerror("Error", "Invalid price.")
            return
        try:
            stock = int(self.stock_e.get().strip())
        except:
            messagebox.showerror("Error", "Invalid stock.")
            return
        cat = self.cat_e.get().strip() or "General"
        try:
            conn = get_db_connection()
            cur = conn.cursor()
            cur.execute("""
                INSERT INTO products (name, price, stock, category)
                VALUES (%s, %s, %s, %s)
            """, (name, price, stock, cat))
            conn.commit()
            conn.close()
            messagebox.showinfo("Added", "Product added.")
            self.app.product_search_frame.load_categories()
            self.app.product_search_frame.load_all()
            self.destroy()
        except Exception as e:
            messagebox.showerror("Error", f"Add product error: {e}")


# =====================================================
# LOGIN / MAIN MENU (uses users table)
# =====================================================
def open_role_window():
    """We no longer ask for role here – we just go to login screen."""
    open_login_window()


def open_login_window():
    global current_user
    current_user = None
    clear_root()

    frame = tk.Frame(root, bg=BG_GRADIENT)
    frame.pack(expand=True, fill="both")

    if LOGO is not None:
        tk.Label(frame, image=LOGO, bg=BG_GRADIENT).pack(pady=(20, 5))

    tk.Label(frame, text="NEXUS TECHSHOP",
             font=("Arial", 16, "bold"),
             fg=TEXT_LIGHT, bg=BG_GRADIENT).pack()

    tk.Label(frame, text="User Login",
             font=("Arial", 10, "italic"),
             fg="#b0b3b8", bg=BG_GRADIENT).pack(pady=(0, 10))

    card = tk.Frame(frame, bg=CARD_COLOR, padx=20, pady=20,
                    highlightthickness=2, highlightbackground=GLOW,
                    highlightcolor=GLOW)
    card.pack(pady=10)

    tk.Label(card, text="LOGIN",
             font=("Arial", 16, "bold"),
             fg=TEXT_LIGHT, bg=CARD_COLOR).pack(pady=(0, 10))

    tk.Label(card, text="Username:", fg=TEXT_LIGHT,
             bg=CARD_COLOR, font=("Arial", 11)).pack(anchor="w")
    entry_user = tk.Entry(card, font=("Arial", 11), width=25)
    entry_user.pack(pady=4)

    tk.Label(card, text="Password:", fg=TEXT_LIGHT,
             bg=CARD_COLOR, font=("Arial", 11)).pack(anchor="w")
    entry_pass = tk.Entry(card, font=("Arial", 11), width=25, show="*")
    entry_pass.pack(pady=4)

    show_var = tk.BooleanVar(value=False)

    def toggle_password():
        entry_pass.config(show="" if show_var.get() else "*")

    tk.Checkbutton(card, text="Show password", variable=show_var,
                   command=toggle_password,
                   bg=CARD_COLOR, fg="#b0b3b8",
                   activebackground=CARD_COLOR,
                   activeforeground="#b0b3b8",
                   selectcolor=CARD_COLOR,
                   font=("Arial", 9)).pack(anchor="w", pady=(0, 4))

    lbl_error = tk.Label(card, text="", fg="#ff6961",
                         bg=CARD_COLOR, font=("Arial", 9, "italic"))
    lbl_error.pack(pady=(0, 4))

    def do_login():
        uname = entry_user.get().strip()
        pwd = entry_pass.get()
        lbl_error.config(text="")
        if not uname or not pwd:
            lbl_error.config(text="Enter username and password.")
            return
        try:
            conn = get_db_connection()
            cur = conn.cursor()
            cur.execute("SELECT password, role FROM users WHERE username=%s", (uname,))
            row = cur.fetchone()
            conn.close()
            if not row:
                lbl_error.config(text="User not found.")
                return
            db_pwd, role = row
            if pwd != db_pwd:
                lbl_error.config(text="Incorrect password.")
                return
            # success
            global current_user
            current_user = (uname, role)
            open_main_menu()
        except Exception as e:
            lbl_error.config(text=f"DB error: {e}")

    tk.Button(card, text="Login", font=("Arial", 12, "bold"),
              bg=ACCENT, fg="white", width=20, bd=0, relief="flat",
              activebackground=ACCENT_HOVER,
              activeforeground="white",
              command=do_login).pack(pady=6)

    tk.Button(frame, text="Exit", font=("Arial", 10),
              bg="#444", fg="white", width=14, bd=0, relief="flat",
              activebackground="#666", activeforeground="white",
              command=root.destroy).pack(pady=10)


def open_main_menu():
    clear_root()
    frame = tk.Frame(root, bg=BG_GRADIENT)
    frame.pack(expand=True, fill="both")

    if LOGO is not None:
        tk.Label(frame, image=LOGO, bg=BG_GRADIENT).pack(pady=(25, 5))

    user_text = f"{current_user[0]} ({current_user[1]})" if current_user else "Guest"

    tk.Label(frame, text="NEXUS TECHSHOP – Dashboard",
             font=("Arial", 18, "bold"),
             fg=TEXT_LIGHT, bg=BG_GRADIENT).pack(pady=(0, 10))

    tk.Label(frame, text=f"Logged in as: {user_text}",
             font=("Arial", 11),
             fg="#b0b3b8", bg=BG_GRADIENT).pack(pady=(0, 20))

    btn_frame = tk.Frame(frame, bg=BG_GRADIENT)
    btn_frame.pack()

    def make_btn(text, cmd):
        b = tk.Button(btn_frame, text=text,
                      font=("Arial", 13, "bold"),
                      bg=ACCENT, fg="white",
                      width=26, height=2, bd=0, relief="flat",
                      activebackground=ACCENT_HOVER,
                      activeforeground="white",
                      command=cmd)
        b.pack(pady=8)
        b.bind("<Enter>", lambda e, bb=b: bb.config(bg=ACCENT_HOVER))
        b.bind("<Leave>", lambda e, bb=b: bb.config(bg=ACCENT))
        return b

    make_btn("Open POS Billing System", lambda: show_pos_page())
    make_btn("Customer Management", lambda: show_customer_page())
    make_btn("Sales Reports Dashboard", lambda: show_reports_page())

    tk.Button(frame, text="Logout", font=("Arial", 10),
              bg="#444", fg="white", width=14, bd=0, relief="flat",
              activebackground="#666", activeforeground="white",
              command=open_login_window).pack(pady=20)


def show_pos_page():
    clear_root()
    POSApp(root)


def show_customer_page():
    clear_root()
    CustomerManagementPage(root)


def show_reports_page():
    clear_root()
    ReportPage(root)


# =====================================================
# SPLASH SCREEN
# =====================================================
def splash_screen():
    splash = tk.Toplevel()
    splash.title("Nexus Loading")
    splash.geometry("360x260")
    splash.overrideredirect(True)
    splash.configure(bg=BG_GRADIENT)

    splash.update_idletasks()
    w = splash.winfo_width()
    h = splash.winfo_height()
    ws = splash.winfo_screenwidth()
    hs = splash.winfo_screenheight()
    x = (ws // 2) - (w // 2)
    y = (hs // 2) - (h // 2)
    splash.geometry(f"+{x}+{y}")

    if LOGO is not None:
        tk.Label(splash, image=LOGO, bg=BG_GRADIENT).pack(pady=(30, 10))

    tk.Label(splash, text="NEXUS TECHSHOP",
             font=("Arial", 16, "bold"),
             fg=TEXT_LIGHT, bg=BG_GRADIENT).pack()

    tk.Label(splash, text="Powering your tech universe",
             font=("Arial", 10, "italic"),
             fg="#b0b3b8", bg=BG_GRADIENT).pack(pady=(0, 15))

    tk.Label(splash, text="Loading Nexus system...",
             font=("Arial", 10),
             fg="#b0b3b8", bg=BG_GRADIENT).pack()

    root.after(1800, lambda: (splash.destroy(), open_login_window()))


# =====================================================
# MAIN
# =====================================================
if __name__ == "__main__":
    root = tk.Tk()
    root.title("Nexus Techshop")
    root.geometry("430x520")
    root.resizable(False, False)
    root.configure(bg=BG_GRADIENT)
    load_logo()
    splash_screen()
    root.mainloop()
